#!/bin/bash

S_LIB_FOLDER=${S_LIB_FOLDER:-/usr/lib/ws-session}
source $S_LIB_FOLDER/lib/source.sh
s_source_lib wm stopwm
s_source app/luakit.sh

SR_BOOKMARKS="$HOME/.config/surfraw/bookmarks"
SR_ELVIFILE="$HOME/.config/surfraw/elvilist"
SR_GO_TO_URL="g"
SR_DEFAULT_ELVI="google"
SR_MENU_TITLE="search the web:"
SR_BROWSER="s_luakit_start"

s_update_elvi() {
  cut -f 1 -d" " "$SR_BOOKMARKS" \
    | grep -v -e "^#" \
    | sort > "$SR_ELVIFILE"
  sr -elvi \
    | grep -v -e "GLOBAL" -e "LOCAL" -e "Activate Surfraw defined" \
    | cut -f1 >> "$SR_ELVIFILE"
}

s_surfraw_menu() {
  if ! [ -f $SR_ELVIFILE ];then
    s_update_elvi
  fi
  search="$(eval "$MENU -p \"$SR_MENU_TITLE\"" <"$SR_ELVIFILE")"
  if ! [ "$search" ]; then
    return 1
  fi
  elvi=${search%% *}
  if [ "$SR_GO_TO_URL" = "$elvi" ]; then
    url="${search#* }"
  elif [ "$(grep -x -e "$elvi" "$SR_ELVIFILE")" ]; then
    url="$(sr -p $search)"
  else
    url="$(sr -p $SR_DEFAULT_ELVI $search)"
  fi
  if [ "$url" ] ; then
    $SR_BROWSER "$url" &
  fi
}

s_surfraw_menu 

# vim: ft=sh ts=2 et sw=2:

